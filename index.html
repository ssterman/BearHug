
<html>
    <head>
        <script src="http://simplewebrtc.com/latest.js"></script>
        <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
        <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script> 
        <link rel="stylesheet" href="index.css" type="text/css"></link>
    </head>
    <body>

    <div id="login_container">
      <div><h1>Welcome to BearHug!</h1></div><br>
      <div> Please enter your unique ID:  <input type="text" id="roomID">
       <input type="Submit" onclick="login()">
       </div>
    </div>
      

      <div id="application_container">
          <div class="header">
              <h1> BearHug </h1>
              <h3>Video Chat with Physical Interactions</h3>
          </div>

          <div id="masterContainer">

              <div id="videoContainer">
                  <div id="localContainer">
                  	<video id="localVideo"></video>
                  </div>
                  <div id="remoteContainer"></div>
              </div>

              <div id="animationContainer">
                  <div id="animation_me_div" class="avatar">
                      <img id="animation_me" src="bear_stand_reversed.gif" >
                      <div id="buttonContainer">
                        <button type="button" id="hugBtn" onclick="hideButtons(); trigger_hug(this)">Hug!</button>
                        <button type="button" id="patBtn" onclick="hideButtons(); trigger_pat(this)">Pat!</button>
                        <button type="button" id="kissBtn" onclick="hideButtons(); trigger_kiss(this)">Kiss!</button>
                      </div>
                  </div>
                  <div id="animation_you_div" class="avatar">
                      <img id="animation_you" src="bear_stand.gif">
                  </div>
              </div>

             
          </div>
        </div>

        <script src="move.js"></script>
       <script>

            var fb_chat_room;

            function login(uid) {
              var roomname = 'cs247' + document.getElementById("roomID").value;
              console.log(roomname);
              document.getElementById("application_container").style.display = "inline";
              document.getElementById("login_container").style.display = "none";

                var webrtc = new SimpleWebRTC({
                // the id/element dom element that will hold "our" video
                localVideoEl: 'localVideo',
                // the id/element dom element that will hold remote videos
                remoteVideosEl: 'remoteContainer',
                // immediately ask for camera access
                autoRequestMedia: true
              });

              // we have to wait until it's ready
              webrtc.on('readyToCall', function () {
                // you can name it anything
                webrtc.joinRoom(roomname);
              });

              //firebase setup            

              fb_chat_room =  new Firebase ("https://test-for-cs247.firebaseio.com/chatrooms/" + roomname);
              console.log("Fb_chat_room", fb_chat_room);

              fb_chat_room.on('child_added', function(snapshot){
                var msg = snapshot.val().m;
                if (msg) {
                  //this makes it so that old messages don't get replayed if entering the same chatroom
                  //currently on a three second window; can change that as needed
                  var timeDifference = Date.now() - snapshot.val().timestamp;
                  if (timeDifference < 3000) {
                    var senderIsMe = (snapshot.val().sender == userID);
                    console.log("RECEIVED: " + msg);
                    console.log("SENDER IS ME: " + senderIsMe);
                    animate(senderIsMe, msg);
                  }
              }
            });

              //fb_chat_room.push({r: roomname});
             // toggle_enable_buttons(true);

            }


             var userID = Math.floor(Math.random()*1000000);
             console.log(userID);
             // Buttons / interactions 
             var interactionOptions = ["#hugBtn", "#patBtn", "#kissBtn"];
            

              WebFontConfig = {
                google: { families: [ 'Amatic+SC::latin' ] }
              };
              (function() {
                var wf = document.createElement('script');
                wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
                  '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
                wf.type = 'text/javascript';
                wf.async = 'true';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(wf, s);
              })();

            function send_trigger(msg) {
              console.log('push');
                fb_chat_room.push({m: msg, sender: userID, timestamp: Date.now()});
            }

            function trigger_hug(el) {
              //  toggle_enable_buttons(false);
                send_trigger("hug");
            }

            function trigger_pat(el) {
             //   toggle_enable_buttons(false);
                send_trigger("pat");
            }

            function trigger_kiss(el) {
               // toggle_enable_buttons(false);
                send_trigger("kiss");
            }

            function animate(senderIsMe, interactionType) {
                // disable buttons for receiver too

                // if (!senderIsMe) {
                //   toggle_enable_buttons(false);
                // }
                // hideButtons();

                console.log("walking");
                var container = document.getElementById("animationContainer");
                var me = document.getElementById("animation_me");
                var you = document.getElementById("animation_you");
                var myLeftOffset = $("#animation_me_div").offset().left;
                var yourLeftOffset = $("#animation_you_div").offset().left;
                
                if (senderIsMe) {
                    // send the action giver to the front, receiver to the back
                    console.log("z-index setting");
                    $('#animation_me_div').css('z-index', 9999);
                    $('#animation_you_div').css('z-index', 1);
                    console.log("I am sender");
                    var senderID = '#animation_me_div';
                    var displacement = yourLeftOffset-myLeftOffset;
                    displacement = (displacement < 0) ? displacement+25 : displacement-25;
                    var reversed = true;
                } else { // sender is the other person
                    // send the action giver to the front, receiver to the back
                    console.log("other z-index setting");
                    $('#animation_you_div').css('z-index', 9999);
                    $('#animation_me_div').css('z-index', 1);
                    console.log("I am receiver");
                    var senderID = '#animation_you_div';
                    var displacement = myLeftOffset-yourLeftOffset;
                    displacement = (displacement < 0) ? displacement+25 : displacement-25;
                    var reversed = false;
                }
                console.log("Displacement: " + displacement);
                 var reverseExtension = reversed ? "_reversed" : "";
                 move(senderID)
                  .set('margin-left', displacement)
                  .duration('5s')
                  // .then()
                  //     .scale(1.5)
                  //     .pop()
                  .end();
                  var newGif = "<img src='bear_walk"+reverseExtension+".gif'>";
                  $(senderID).children("img").remove();
                  $(senderID).prepend(newGif);

                  interact(interactionType, senderID, reversed);

                  setTimeout(function(){
                      // flip bear other way
                      move(senderID)
                      .set('margin-left', 0)
                      .duration('5s')
                      .end();

                      var reverseExtension = reversed ? "" : "_reversed";
                      var newGif = "<img src='bear_walk"+reverseExtension+".gif' id='animation_me' >";
                      $(senderID).children("img").remove();
                      $(senderID).prepend(newGif);
                      setTimeout(function(){
                         var reverseExtension = reversed ? "_reversed" : "";
                         var newGif = "<img src='bear_stand"+reverseExtension+".gif' id='animation_me' >";
                         $(senderID).children("img").remove();
                         $(senderID).prepend(newGif);

                         toggle_enable_buttons(true); // re-enable buttons;
                      }, 5000);
                  }, 9000);
                // Right now just x-axis, but changing it to 2D path should be easy

            }

            // params: interactionType eg. "hug" and who sent the hug aka which DIV does the hugging action eg. animation_you_div
            function interact(interactionType, senderID, reversed) {
                var reverseExtension = reversed ? "_reversed" : "";
                switch (interactionType){
                    case "hug":  
                        setTimeout(function(){
                          var newGif = "<img src='bear_hug"+reverseExtension+".gif' id='animation_me' >";
                          $(senderID).children("img").remove();
                          $(senderID).prepend(newGif);
                        }, 5000);
                        break;
                    case "kiss": 
                        setTimeout(function(){
                          var newGif = "<img src='bear_kiss"+reverseExtension+".gif' id='animation_me' >";
                          $(senderID).children("img").remove();
                          $(senderID).prepend(newGif);
                        }, 5000);
                        break;
                    case "pat": 
                        setTimeout(function(){
                          var newGif = "<img src='bear_pat"+reverseExtension+".gif' id='animation_me' >";
                          $(senderID).children("img").remove();
                          $(senderID).prepend(newGif);
                        }, 5000);
                        break;
                }
            }
          
            function showButtons() {
              $('#buttonContainer').show();
              // bonus: do cool popup animation
            }

          
            function hideButtons() {
              $('#buttonContainer').css( "display", "none" );

              // bonus: do cool popup animation
            }

            // On click of ME bear, button toggles hidden/displayed
            // DIV vs IMAGE toggle button not working WIP
            $("#animation_me_div").on("click", function(e){
              console.log($("#buttonContainer"));
                 var visible = $("#buttonContainer").is(":visible");
                 console.log(visible);
                 $("#buttonContainer").toggle( !visible ); //.scale(1.5);
              });
           

       </script>

  

    </body>
</html>
