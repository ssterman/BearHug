<html>
    <head>
        <script src="http://simplewebrtc.com/latest.js"></script>
        <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
        <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script> 
        <link rel="stylesheet" href="index.css" type="text/css"></link>
    </head>
    <body>
    	<div id="localContainer">
        	<video id="localVideo"></video>
        </div>
        <div id="remoteContainer"></div>

        <div id="animationContainer">
            <div id="animation_me_div" class="avatar">
                <img id="animation_me" src="standing.png" >
            </div>
            <div id="animation_you_div" class="avatar">
                <img id="animation_you" src="standing.png">
            </div>
        </div>

        <div id="buttonContainer">
        	<button type="button" onclick="trigger_hug()">Hug!</button>
        	<button type="button" onclick="trigger_pat()">Pat!</button>
        	<button type="button" onclick="trigger_kiss()">Kiss!</button>
        </div>

        <script src="move.js"></script>
       <script>
                     var userID = Math.floor(Math.random()*1000000);
                     console.log(userID);
        //document.body.style.background="#ffffff"; //"#f3f3f3 url('img_tree.png') no-repeat right top";

   var webrtc = new SimpleWebRTC({
              // the id/element dom element that will hold "our" video
              localVideoEl: 'localVideo',
              // the id/element dom element that will hold remote videos
              remoteVideosEl: 'remoteContainer',
              // immediately ask for camera access
              autoRequestMedia: true
            });

            // we have to wait until it's ready
            webrtc.on('readyToCall', function () {
              // you can name it anything
              webrtc.joinRoom('cs247');
            });

            //firebase setup            
            fb_instance = new Firebase("https://avatar-gestures.firebaseio.com/");

            function send_trigger(msg) {
                fb_instance.push({m: msg, sender: userID});
            }
            
            fb_instance.on('child_added', function(snapshot){
                var msg = snapshot.val().m;
                var senderIsMe = (snapshot.val().sender == userID);
                console.log("RECEIVED: " + msg);
                console.log("SENDER IS ME: " + senderIsMe);
                fb_instance.remove();
                if (msg == "hug") {
                    animateHug(senderIsMe);
                } else if (msg == "kiss") {
                    animateKiss(senderIsMe);
                } else if (msg == "pat") {
                    animatePat(senderIsMe);
                }
            });


            function trigger_hug() {
                send_trigger("hug");
            }

            function trigger_pat() {
                send_trigger("pat");
            }

            function trigger_kiss() {
                send_trigger("kiss");
            }

            function animateHug(senderIsMe) {
                var container = document.getElementById("animationContainer");
                var me = document.getElementById("animation_me");
                var you = document.getElementById("animation_you");
                animateWalk();
                setTimeout(function(){$("#animation_me_div").html("<img src='hugging.gif'>")}, 5000);
                    
            }

            function animateWalk(senderIsMe) {
                console.log("walking");
                var container = document.getElementById("animationContainer");
                var me = document.getElementById("animation_me");
                var you = document.getElementById("animation_you");
                $("#animation_me_div").html("<img src='walking.gif'>");
                move('#animation_me_div')
                  .set('margin-left', -980)
                  .duration('5s')
                  .then()
                      .rotate(-30)
                      .scale(1.5)
                      .pop()
                  .end();
                //$("#animation_me_div").html("<img src='standing.png'>");
            }

            //reference: http://www.schillmania.com/content/projects/javascript-animation-1/
            // function move(me, you) {
            //     me.style.left = parseInt(me.style.left)+1+'px';
            //     if (me.left != you.left) {
            //         setTimeout(move(me, you),20); // call doMove in 20msec
            //     } else {
            //         me.src ="hug.gif";
            //     }
            // }
       </script>

<!--  TESTING
<style>
     .box{display:block;width:50px;height:25px;background-color:#222;}
    </style>
     <script>
      addEventListener('DOMContentLoaded', function(){
        setInterval(function(){
            move('.box').x(600).duration('1s').set('width',5).end();
            setTimeout(function(){move('.box').x(0).duration('1s').set('width',50).end();},1000)
        },2500)
      }, false);
    </script>
    <div class="box"></div> -->

    </body>
</html>