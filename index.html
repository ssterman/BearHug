<html>
    <head>
        <script src="http://simplewebrtc.com/latest.js"></script>
        <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
        <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script> 
        <link rel="stylesheet" href="index.css" type="text/css"></link>
    </head>
    <body>
        <div class="header">
            <h1> BearHug </h1>
            <h3>Video Chat with Avatars</h3>
        </div>

        <div id="masterContainer">

            <div id="videoContainer">
            	<div id="localContainer">
                	<video id="localVideo"></video>
                </div>
                <div id="remoteContainer"></div>
            </div>

            <div id="animationContainer">
                <div id="animation_me_div">
                    <img id="animation_me" src="wait.gif">
                </div>
                <div id="animation_you_div">
                    <img id="animation_you" src="wait.gif">
                </div>
            </div>

            <div id="buttonContainer">
            	<button type="button" onclick="trigger_hug()">Hug!</button>
            	<button type="button" onclick="trigger_pat()">Pat!</button>
            	<button type="button" onclick="trigger_kiss()">Kiss!</button>
            </div>
        </div>

        <script>


   var webrtc = new SimpleWebRTC({
              // the id/element dom element that will hold "our" video
              localVideoEl: 'localVideo',
              // the id/element dom element that will hold remote videos
              remoteVideosEl: 'remoteContainer',
              // immediately ask for camera access
              autoRequestMedia: true
            });

            // we have to wait until it's ready
            webrtc.on('readyToCall', function () {
              // you can name it anything
              webrtc.joinRoom('cs247');
            });

            //firebase setup            
            fb_instance = new Firebase("https://avatar-gestures.firebaseio.com/");

            function send_trigger(msg) {
                fb_instance.push({m: msg});
            }
            
            fb_instance.on('child_added', function(snapshot){
                var msg = snapshot.val().m;
                console.log(msg);
                fb_instance.remove();
                if (msg == "hug") {
                    console.log("received hug and starting animation");
                    animateHug();
                } else if (msg == "kiss") {
                    // animateKiss();
                } else if (msg == "pat") {
                    // animatePat();
                }
            });

            function animateHug() {
                // console.log("animating hug");
                var container = document.getElementById("animationContainer");
                var me = document.getElementById("animation_me_div");
                var you = document.getElementById("animation_you_div");
                
                animateWalk();
                me.src ="hug.gif";

            }

            function trigger_hug() {
                animateHug();
                send_trigger("hug");
            }

            function trigger_pat() {
                // send_trigger("pat");
            }

            function trigger_kiss() {
                // send_trigger("kiss");
            }

            function animate(senderIsMe, interactionType) {
                console.log("walking");
                var container = document.getElementById("animationContainer");
                var me = document.getElementById("animation_me");
                var you = document.getElementById("animation_you");
                var myLeftOffset = $("#animation_me_div").offset().left;
                var yourLeftOffset = $("#animation_you_div").offset().left;
                
                if (senderIsMe) {
                    console.log("I am sender");
                    var senderID = '#animation_me_div';
                    var displacement = yourLeftOffset-myLeftOffset;
                } else { // sender is the other person
                    console.log("I am receiver");
                    var senderID = '#animation_you_div';
                    var displacement = myLeftOffset-yourLeftOffset;
                }
        
                // if walking to the left, make the gif face left
                if (displacement < 0) {
                    $(senderID).addClass("flip");
                }
                 move(senderID)
                  .set('margin-left', displacement)
                  .duration('5s')
                  .then()
                      .scale(1.5)
                      .pop()
                  .end();
                  $(senderID).html("<img src='walking.gif'>");

                  interact(interactionType, senderID);

                  setTimeout(function(){
                      // flip bear other way
         
                      move(senderID)
                      .set('margin-left', 0)
                      .duration('5s')
                      .end();
                      $(senderID).html("<img src='walking.gif'>");
                      setTimeout(function(){
                         $(senderID).html("<img src='standing.png'>")
                      }, 5000);
                  }, 9000);


                  
           
                
                // Right now just x-axis, but changing it to 2D path should be easy
               

                // if (me.offsetLeft-you.offsetLeft > 0) {
                //     move(me, you, -1);
                // } else {
                //     move(me, you, 1);
                // }
            }


            </script>


    </body>
</html>