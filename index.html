
<html>
<head>
  <script src="http://simplewebrtc.com/latest.js"></script>
  <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
  <script src="http://www.kirupa.com/prefixfree.min.js"></script>
  <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script> 
  <link rel="stylesheet" href="index.css" type="text/css"></link>
</head>
<body>

  <div id="login_container">
    <div><h1>Welcome to BearHug!</h1></div><br>
    <div> Please enter your unique ID:  <input type="text" id="roomID">
     <input type="Submit" onclick="login()">
   </div>
 </div>

 <div id="application_container">
  <div class="header">
    <h1> BearHug </h1>
    <h3>Video Chat with Physical Interactions</h3>
  </div>

  <div id="masterContainer">

    <div id="videoContainer">
      <div id="localContainer">
       <video id="localVideo"></video>
     </div>
     <div id="remoteContainer"></div>
   </div>

   <div id="animationContainer">
    <div id="animation_me_div" class="avatar" onmouseover="showButtons()" onmouseout="hideButtons()">
      <img id="animation_me" src="bear_stand_reversed.gif" >
      <div id="buttonContainer">
        <button type="button" id="hugBtn" onclick="hideButtons(); send_gesture('hug');">Hug!</button>
        <button type="button" id="patBtn" onclick="hideButtons(); send_gesture('pat');">Pat!</button>
        <button type="button" id="kissBtn" onclick="hideButtons(); send_gesture('kiss');">Kiss!</button>
      </div>
    </div>
    <div id="animation_you_div" class="avatar">
      <img id="animation_you" src="bear_stand.gif">
    </div>
  </div>
</div>
</div>

<script src="move.js"></script>
<script>

var fb_chat_room;

function login(uid) {
  var roomname = 'cs247' + document.getElementById("roomID").value;
  console.log(roomname);
  document.getElementById("application_container").style.display = "inline";
  document.getElementById("login_container").style.display = "none";

  var webrtc = new SimpleWebRTC({
        // the id/element dom element that will hold "our" video
        localVideoEl: 'localVideo',
        // the id/element dom element that will hold remote videos
        remoteVideosEl: 'remoteContainer',
        // immediately ask for camera access
        autoRequestMedia: true
      });

      // we have to wait until it's ready
      webrtc.on('readyToCall', function () {
        // you can name it anything
        webrtc.joinRoom(roomname);
      });

      //firebase setup            

      fb_chat_room =  new Firebase ("https://test-for-cs247.firebaseio.com/chatrooms/" + roomname);
      console.log("Fb_chat_room", fb_chat_room);

      fb_chat_room.on('child_added', function(snapshot){
        var msg = snapshot.val().m;
        if (msg) {
          //this makes it so that old messages don't get replayed if entering the same chatroom
          //currently on a three second window; can change that as needed
          var timeDifference = Date.now() - snapshot.val().timestamp;
          if (timeDifference < 3000) {
            var senderIsMe = (snapshot.val().sender == userID);
            console.log("RECEIVED: " + msg);
            console.log("SENDER IS ME: " + senderIsMe);
            
            // Animate gesture for sender or walk to x-y coord.
            if (msg == "walk" && !senderIsMe) { // animate YOU bear walking
                moveToCoordinates('#animation_you_div', snapshot.val().x, snapshot.val().y);
            } else if (senderIsMe) { // animate ME bear gesture
              var senderDivElementID = '#animation_me_div';
              // reversed controls which way the bear is facing when doing gesture
              // and is determined by checking the innerHTML of the animation me div and seeing
              // if there is a reversed substring (from the gif image)
              var innerHTML = $(senderDivElementID).html();
              var reversed = innerHTML.match(/reversed/) == "reversed";
              interact(msg, senderDivElementID, reversed, true);
            } else { // animate YOU bear gesture
              // 'sender is not ME' aka you are the RECEIVER and you need to animate the SENDER's bear
              // TODO: Animate gesture for receiver
              var receiverDivElementID = '#animation_you_div';
              var innerHTML = $(receiverDivElementID).html();
              var reversed = innerHTML.match(/reversed/) == "reversed";
              interact(msg, receiverDivElementID, reversed, false);
            }

          }
        }
      });

      //fb_chat_room.push({r: roomname});
     // toggle_enable_buttons(true);

   }


   var userID = Math.floor(Math.random()*1000000);
   console.log(userID);
     // Buttons / interactions 
     var interactionOptions = ["#hugBtn", "#patBtn", "#kissBtn"];


     WebFontConfig = {
      google: { families: [ 'Amatic+SC::latin' ] }
    };
    (function() {
      var wf = document.createElement('script');
      wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
      wf.type = 'text/javascript';
      wf.async = 'true';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(wf, s);
    })();

    function send_gesture(msg) {
      console.log('push gesture');
      fb_chat_room.push({m: msg, sender: userID, timestamp: Date.now()});
    }

    // NOW STALE: THIS WAS ANIMATION CHOREOGRAPHED FOR 1D linear movement 
    /*
    function animate(senderIsMe, interactionType) {
        // disable buttons for receiver too

        // if (!senderIsMe) {
        //   toggle_enable_buttons(false);
        // }
        // hideButtons();

        console.log("walking");
        var container = document.getElementById("animationContainer");
        var me = document.getElementById("animation_me");
        var you = document.getElementById("animation_you");
        var myLeftOffset = $("#animation_me_div").offset().left;
        var yourLeftOffset = $("#animation_you_div").offset().left;
        
        if (senderIsMe) {
            // send the action giver to the front, receiver to the back
            console.log("z-index setting");
            $('#animation_me_div').css('z-index', 9999);
            $('#animation_you_div').css('z-index', 1);
            console.log("I am sender");
            var senderDivElementID = '#animation_me_div';
            var displacement = yourLeftOffset-myLeftOffset;
            displacement = (displacement < 0) ? displacement+25 : displacement-25;
            var reversed = true;
        } else { // sender is the other person
            // send the action giver to the front, receiver to the back
            console.log("other z-index setting");
            $('#animation_you_div').css('z-index', 9999);
            $('#animation_me_div').css('z-index', 1);
            console.log("I am receiver");
            var senderDivElementID = '#animation_you_div';
            var displacement = myLeftOffset-yourLeftOffset;
            displacement = (displacement < 0) ? displacement+25 : displacement-25;
            var reversed = false;
        }
        console.log("Displacement: " + displacement);
         var reverseExtension = reversed ? "_reversed" : "";
         move(senderDivElementID)
          .set('margin-left', displacement)
          .duration('5s')
          // .then()
          //     .scale(1.5)
          //     .pop()
          .end();
          var newGif = "<img src='bear_walk"+reverseExtension+".gif'>";
          $(senderDivElementID).children("img").remove();
          $(senderDivElementID).prepend(newGif);

          interact(interactionType, senderDivElementID, reversed);

          setTimeout(function(){
              // flip bear other way
              move(senderDivElementID)
              .set('margin-left', 0)
              .duration('5s')
              .end();

              var reverseExtension = reversed ? "" : "_reversed";
              var newGif = "<img src='bear_walk"+reverseExtension+".gif' id='animation_me' >";
              $(senderDivElementID).children("img").remove();
              $(senderDivElementID).prepend(newGif);
              setTimeout(function(){
                 var reverseExtension = reversed ? "_reversed" : "";
                 var newGif = "<img src='bear_stand"+reverseExtension+".gif' id='animation_me' >";
                 $(senderDivElementID).children("img").remove();
                 $(senderDivElementID).prepend(newGif);

                 toggle_enable_buttons(true); // re-enable buttons;
              }, 5000);
          }, 9000);
        // Right now just x-axis, but changing it to 2D path should be easy
    }
    */

    function showButtons() {
      $('#buttonContainer').show();
      // bonus: do cool popup animation
    }

    function hideButtons() {
      $('#buttonContainer').css( "display", "none" ); 
      // bonus: do cool popup animation
    }

    // var notMoving = true;

    // FUNCTION INTERACT
    // params: 
    // * interactionType eg. "hug" and who sent the hug aka which DIV does the hugging action eg. animation_you_div
    //    interactionType is a string either "hug" "pat" or "kiss"
    // * senderDivElement ID: either 'animation_me_div' or 'animation_you_div' div that holds the animated bear
    // * reversed: if bear is reversed (facing left) or normal (facing right)
    // * senderIsMe: did you send this interaction (right bear) or are you the receiver of it (left bear)
    function interact(interactionType, senderDivElementID, reversed, senderIsMe) {
      console.log("INTERACTING...");
      var reverseExtension = reversed ? "_reversed" : "";
      var imgID = senderIsMe ? "animation_me" : "animation_you";
      console.log("second stand source");
      var waitGif = "<img src='bear_stand"+reverseExtension+".gif' id='"+imgID+"' >";
      var newGif = "<img src='bear_"+interactionType+reverseExtension+".gif' id='"+imgID+"' >";
      $(senderDivElementID).children("img").remove();
      $(senderDivElementID).prepend(newGif);
      var oldZIndex = $(senderDivElementID).css("z-index");
      $(senderDivElementID).css("z-index","10000");

      //use these values to see if bear has moved
      var curx = $(senderDivElementID).position().left;
      var cury = $(senderDivElementID).position().top;
      setTimeout(function(){
          // Return to normal waiting pose after 5 sec
          //check if bear has moved; only do action if in same place
            if (curx == $(senderDivElementID).position().left && cury == $(senderDivElementID).position().top) {
                  $(senderDivElementID).children("img").remove();
                  console.log("fourth stand source");
                  $(senderDivElementID).prepend(waitGif);
                  $(senderDivElementID).css("z-index",oldZIndex);
         }
        }, 5000);
    }

    // To move receiver bear (left bear) after firebase receival of message
    function moveToCoordinates(senderDivElementID, x, y) {
            // notMoving = false;
      console.log("POS OF 'YOU' BEAR (" + x + ", " + y + ")");
      var imgID = senderDivElementID == "#animation_you_div" ? "animation_you" : "animation_me";
      var bear = document.querySelector(senderDivElementID);
      var container = document.querySelector("#animationContainer");
      var bearCenterPosition = getCenterCoords($(senderDivElementID));
      var reversed = bearCenterPosition.x > x;
      var reverseExtension = reversed ? "_reversed" : "";
      var walkGif = "<img src='bear_walk"+reverseExtension+".gif' id='"+imgID+"' >";
      $(senderDivElementID).children("img").remove();
      $(senderDivElementID).prepend(walkGif);
      // setTimeout(function(){
      //   console.log("third stand source");
      //   var waitGif = "<img src='bear_stand"+reverseExtension+".gif' id='"+imgID+"' >";
      //   $(senderDivElementID).children("img").remove();
      //   $(senderDivElementID).prepend(waitGif);
      // }, 1500);

        var animationEvent = whichAnimationEvent('animation_you_div');
        console.log("animationEvent", animationEvent);
        document.addEventListener(animationEvent, function() {
          animationListener(animationEvent, 'animation_you_div', reverseExtension);
          document.removeEventListener(animationEvent, arguments.callee);
        });

      bear.style.left = x + "px"; // (x + bearCenterPosition.x) + "px";
      bear.style.top = y + "px"; //  (y + bearCenterPosition.y) + "px";
    }

    // HUG KISS PAT BUTTONS TOGGLE
    // On click of ME bear, button toggles hidden/displayed
    $("#animation_me_div").on("click", function(e){
      console.log($("#buttonContainer"));
      var visible = $("#buttonContainer").is(":visible");
      console.log(visible);
         $("#buttonContainer").toggle( !visible ); //.scale(1.5);

        // Stops event from triggering the bear movement 2D movement next:
        // if mouseclick is within the buttonContainer div, do not move bear because
        // this means the user is just trying to click a button or hide/show button container
        e.stopPropagation(); 
      });

    // CODE FOR CONTROLLING "ME" BEAR 2D ANIMATION ON MOUSE CLICK
    // The ME Bear 2D animation within the animationContainer div
    var meBear = document.querySelector("#animation_me_div");
    var container = document.querySelector("#animationContainer");
    //var container = document.body;

    container.addEventListener("click", moveBearToClickPosition, false);



    function moveBearToClickPosition(e) {
      // notMoving = false;
      var parentPosition = getPosition(e.currentTarget);
      var xPosition = e.clientX - parentPosition.x - (meBear.clientWidth / 2);
      var yPosition = e.clientY - parentPosition.y - (meBear.clientHeight / 2);
      
      // Push to firebase so RECEIVER can animate bear
      //var receiverBearDisplacementX = getCenterCoords($('#animation_me_div')).x - xPosition; // x pos mirrored  
      //var receiverBearDisplacementY = yPosition; // y pos the same
      var receiverBearNewX = $('#animationContainer').width() - (e.clientX - parentPosition.x); // - (meBear.clientWidth / 2)); // MIRROR IMAGE
      var receiverBearNewY = e.clientY - parentPosition.y  - (meBear.clientHeight / 2);
      console.log('push 2D walking');
      fb_chat_room.push({m: "walk", x: receiverBearNewX, y: receiverBearNewY, sender: userID, timestamp: Date.now()});

        // 1. Compare click position relative to bear position to see if bear will be walking fwd or backward
        // aka reversed GIF or normal walking GIF
        var bearCenterPosition = getCenterCoords($('#animation_me_div'));
        var reversed = bearCenterPosition.x > e.clientX;

        console.log("YOOOOO");
        console.log(bearCenterPosition.x, e.clientX);


        var reverseExtension = reversed ? "_reversed" : "";
        console.log("walk source");
        var walkGif = "<img src='bear_walk"+reverseExtension+".gif' id='animation_me' >";
        $('#animation_me_div').children("img").remove();
        $('#animation_me_div').prepend(walkGif);
        //put this back in
        // setTimeout(function(){
        //   console.log("stand source");
        //   var waitGif = "<img src='bear_stand"+reverseExtension+".gif' id='animation_me' >";
        //   $('#animation_me_div').children("img").remove();
        //   $('#animation_me_div').prepend(waitGif);
        // }, 1500);
     

        /* Listen for a transition! */
        //this fires at the end of an animation, to turn the bear from walking to standing
        var animationEvent = whichAnimationEvent('animation_me_div');
        console.log("animationEvent", animationEvent);
        document.addEventListener(animationEvent, function() {
          animationListener(animationEvent, 'animation_me_div', reverseExtension);
          document.removeEventListener(animationEvent, arguments.callee);
        });

        meBear.style.left = xPosition + "px";
        meBear.style.top = yPosition + "px";
      }

      function animationListener(e, div, reverseExtension) {
          console.log('Transition complete!  This is the callback, no library needed!');
          var waitGif = "<img src='bear_stand"+reverseExtension+".gif' id='animation_me' >";
          $('#animation_me_div').children("img").remove();
          $('#animation_me_div').prepend(waitGif);
          // notMoving = true;
          document.removeEventListener(e, animationListener);
        }

      /* From Modernizr */
      //http://davidwalsh.name/css-animation-callback
      function whichAnimationEvent(div){
          var a;
          var el = document.getElementById(div);
          var animations = {
            'transition':'transitionend',
            'OTransition':'oTransitionEnd',
            'MozTransition':'transitionend',
            'WebkitTransition':'webkitTransitionEnd'
          }

          for(a in animations){
              if( el.style[a] !== undefined ){
                  return animations[a];
              }
          }
      }


      function getPosition(element) {
        var xPosition = 0;
        var yPosition = 0;

        while (element) {
          xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
          yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
          element = element.offsetParent;
        }
        return { x: xPosition, y: yPosition };
      }

    // get center position for an element
    function getCenterCoords(element) {
      var offset = element.offset();
      var width = element.width();
      var height = element.height();

      var centerX = offset.left + width / 2;
      var centerY = offset.top + height / 2;
      return {x: centerX, y: centerX};
    }
    </script>
  </body>
</html>
